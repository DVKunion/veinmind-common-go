package event

import (
	"time"

	"github.com/jedib0t/go-pretty/v6/table"
	"github.com/jedib0t/go-pretty/v6/text"
)

type VulnDetail struct {
	ID         string       `json:"id"`
	Published  time.Time    `json:"published"`
	Aliases    []string     `json:"aliases"`
	Summary    string       `json:"summary"`
	Details    string       `json:"details"`
	References []References `json:"references"`
	Source     Source       `json:"source"`
}

func init() {
	RegisterAlter(Vulnerability, func() *DetailInfo { return NewDetailInfo(&VulnDetail{}) })
}

type References struct {
	Type string `json:"type"`
	URL  string `json:"url"`
}

type Source struct {
	OS       AssetOSDetail      `json:"os"`
	Type     string             `json:"type"`
	FilePath string             `json:"file_path"`
	Packages AssetPackageDetail `json:"packages"`
}

func (v *VulnDetail) RenderTable(id string, level Level) []table.Row {
	data := make([]table.Row, 0)
	cve := v.Aliases
	if len(cve) == 0 {
		cve = []string{v.ID}
	}
	for _, c := range cve {
		data = append(data, table.Row{simply(id), v.Source.Type, v.Source.Packages.Name,
			v.Source.Packages.Version, v.Source.FilePath, c, func() string {
				if v.Summary == "" {
					return v.Details
				}
				return v.Summary
			}(),
		})
	}
	return data
}

func (v *VulnDetail) RenderTableHeader() table.Row {
	return table.Row{"FROM", "TYPE", "NAME", "VERSION", "PATH", "CVE", "SUMMARY"}
}

func (v *VulnDetail) RenderTableTitle() string {
	return "VULN-INFO"
}

func (v *VulnDetail) RenderRowConfig() table.RowConfig {
	return table.RowConfig{}
}

func (v *VulnDetail) RenderColumnConfig() []table.ColumnConfig {
	return []table.ColumnConfig{
		{Number: 1, WidthMax: 12, AutoMerge: true},
		{Number: 2, WidthMax: 18, AutoMerge: true},
		{Number: 3, WidthMax: 12, AutoMerge: true},
		{Number: 4, WidthMax: 32, Align: text.AlignJustify, AutoMerge: true},
		{Number: 5, WidthMax: 32, Align: text.AlignJustify, AutoMerge: true},
		{Number: 6, WidthMax: 20, Align: text.AlignJustify},
		{Number: 7, WidthMax: 32, Align: text.AlignJustify},
	}
}
